name: iOS â€” TestFlight (Signed)

on:
  workflow_dispatch:

env:
  APP_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker
  EXT_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker.Extension
  PROJECT_PATH: ios/SignInPromptBlocker/SignInPromptBlocker.xcodeproj
  SCHEME: SignInPromptBlocker

jobs:
  build_and_upload:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create keychain & import .p12
        run: |
          KEYCHAIN=build.keychain
          security create-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          echo "${{ secrets.P12_BASE64 }}" | base64 --decode > dist.p12
          security import dist.p12 -k "$KEYCHAIN" -P "${{ secrets.P12_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

      - name: Install provisioning profiles (app + extension)
        id: profiles
        shell: bash
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.PROVISION_PROFILE_ALL_BASE64 }}" | base64 --decode > app.mobileprovision
          echo "${{ secrets.PROVISION_PROFILE_EXT_BASE64 }}" | base64 --decode > ext.mobileprovision
          # Extract UUID + Name for both (needed by exportOptions)
          getInfo () {
            /usr/bin/security cms -D -i "$1" > tmp.plist
            UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' tmp.plist)
            NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' tmp.plist)
            echo "$UUID $NAME"
            mv "$1" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"
            rm -f tmp.plist
          }
          read APP_UUID APP_NAME < <(getInfo app.mobileprovision)
          read EXT_UUID EXT_NAME < <(getInfo ext.mobileprovision)
          echo "APP_UUID=$APP_UUID" >> $GITHUB_OUTPUT
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "EXT_UUID=$EXT_UUID" >> $GITHUB_OUTPUT
          echo "EXT_NAME=$EXT_NAME" >> $GITHUB_OUTPUT

      - name: Build archive (Release, signed)
        run: |
          set -e
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            clean archive | xcpretty

      - name: Create export options (App Store)
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>stripSwiftSymbols</key><true/>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ env.APP_BUNDLE_ID }}</key><string>${{ steps.profiles.outputs.APP_NAME }}</string>
              <key>${{ env.EXT_BUNDLE_ID }}</key><string>${{ steps.profiles.outputs.EXT_NAME }}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist | xcpretty
          ls -la build/export

      - name: Install fastlane
        run: sudo gem install fastlane -NV

      - name: Prepare ASC API key (safe JSON)
        run: |
          # your secret APP_STORE_CONNECT_KEY is base64 of the .p8 (keeps newlines)
          echo "${{ secrets.APP_STORE_CONNECT_KEY }}" | base64 --decode > AuthKey.p8
          python3 - <<'PY'
          import os, json
          with open('AuthKey.p8','r') as f:
              key = f.read()
          data = {
              "key_id": os.environ["KID"],
              "issuer_id": os.environ["ISSUER"],
              "key": key,
              "in_house": False
          }
          with open('api_key.json','w') as f:
              json.dump(data, f)
          PY
        env:
          KID: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight
        run: |
          IPA_PATH=$(ls build/export/*.ipa | head -n 1)
          fastlane pilot upload --api_key_path api_key.json --ipa "$IPA_PATH" --skip_waiting_for_build_processing true

      - name: Upload IPA as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/export/*.ipa
