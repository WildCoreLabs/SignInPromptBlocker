name: iOS – Bg)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      APP_NAME: SignInPromptBlocker
      BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker

      # Team / Signing
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      P12_BASE64: ${{ secrets.P12_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}

      # App Store Connect API key (full multi-line .p8 is OK)
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Sanity check extension
        run: |
          set -euxo pipefail
          ls -la "$GITHUB_WORKSPACE/extension"
          test -f "$GITHUB_WORKSPACE/extension/manifest.json"

      # Convert MV3 → Xcode (write into $RUNNER_TEMP)
      - name: Convert WebExtension → Xcode project
        run: |
          set -euxo pipefail
          EXT="$GITHUB_WORKSPACE/extension"
          PROJ="$RUNNER_TEMP/safari_project"
          mkdir -p "$PROJ"
          /usr/bin/xcrun safari-web-extension-converter --ios-only --no-open --force \
            --app-name "$APP_NAME" \
            --bundle-identifier "$BUNDLE_ID" \
            --project-location "$PROJ" \
            "$EXT"

      # Force unique bundle IDs so extension ≠ app
      - name: Force unique bundle IDs (app vs extension targets)
        run: |
          set -euxo pipefail
          WS=$(find "$RUNNER_TEMP" -maxdepth 8 -type d -name '*.xcworkspace' -print -quit)
          test -n "$WS"
          PROJDIR="$(dirname "$WS")"
          PBXPROJ=$(find "$PROJDIR" -maxdepth 8 -type f -name project.pbxproj -print -quit)
          test -f "$PBXPROJ"

          # 1) default ALL targets to .Extension
          perl -pi -e 's/\bcom\.wildcorelabs\.SignInPromptBlocker\b/com.wildcorelabs.SignInPromptBlocker.Extension/g' "$PBXPROJ"

          # 2) restore the main APP target back to base id
          perl -0777 -i -pe \
            's{(/\*\s*SignInPromptBlocker(?:\s*\(iOS\))?\s*\*/.*?PRODUCT_BUNDLE_IDENTIFIER\s*=\s*)com\.wildcorelabs\.SignInPromptBlocker\.Extension(;)}{$1com.wildcorelabs.SignInPromptBlocker$2}s' \
            "$PBXPROJ"

          echo "Bundle IDs after fix:"
          grep -n 'PRODUCT_BUNDLE_IDENTIFIER' "$PBXPROJ" | sed -n '1,200p'

      # Discover workspace & scheme dynamically
      - name: Discover workspace path
        run: |
          set -euxo pipefail
          WS=$(find "$RUNNER_TEMP" -maxdepth 8 -type d -name '*.xcworkspace' -print -quit)
          test -n "$WS" || { echo "No .xcworkspace under RUNNER_TEMP"; exit 1; }
          echo "WS=$WS" | tee -a $GITHUB_ENV

      - name: Discover app scheme
        run: |
          set -euxo pipefail
          xcodebuild -list -json -workspace "$WS" > schemes.json
          python3 - <<'PY' | tee -a $GITHUB_ENV
          import json, re, os, sys
          j=json.load(open('schemes.json'))
          schemes=j.get('workspace',{}).get('schemes',[])
          if not schemes: sys.exit("No schemes found")
          app=os.environ.get('APP_NAME','').strip().lower()
          cands=[s for s in schemes if re.search(r'\(iOS\)|iOS', s, re.I) or s.strip().lower()==app]
          pick=cands[0] if cands else schemes[0]
          print(f"SCHEME={pick}")
          PY
          echo "Schemes:"; cat schemes.json

      # Signing: decode/import cert & profile
      - name: Decode signing assets
        run: |
          set -euxo pipefail
          mkdir -p signing
          echo "$P12_BASE64" | base64 --decode > signing/dist.p12
          echo "$PROFILE_BASE64" | base64 --decode > signing/profile.mobileprovision

      - name: Create custom keychain & import cert
        run: |
          set -euxo pipefail
          KEYCHAIN="$RUNNER_TEMP/build.keychain"
          KEYCHAIN_PWD="$(uuidgen)"
          echo "KEYCHAIN=$KEYCHAIN" >> $GITHUB_ENV
          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security import signing/dist.p12 -k "$KEYCHAIN" -P "$P12_PASSWORD" -A
          security list-keychains -s "$KEYCHAIN" $(security list-keychains | sed 's/.*"\(.*\)".*/\1/')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN"

      - name: Install provisioning profile
        run: |
          set -euxo pipefail
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i signing/profile.mobileprovision)")
          cp signing/profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision"
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "Using provisioning profile UUID: $PROFILE_UUID"

      # Build archive
      - name: Build (archive) with xcodebuild
        run: |
          set -euxo pipefail
          ARCHIVE_PATH="$GITHUB_WORKSPACE/build/${APP_NAME}.xcarchive"
          xcodebuild -workspace "$WS" -scheme "$SCHEME" -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_UUID}" \
            PROVISIONING_PROFILE="${PROFILE_UUID}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN" \
            clean archive

      # ExportOptions & export IPA
      - name: Create ExportOptions.plist
        run: |
          set -euxo pipefail
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key><dict>
              <key>${BUNDLE_ID}</key><string>${PROFILE_UUID}</string>
            </dict>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict></plist>
          EOF
          echo "=== ExportOptions.plist ==="
          cat ExportOptions.plist

      - name: Export .ipa
        run: |
          set -euxo pipefail
          xcodebuild -exportArchive \
            -archivePath "build/${APP_NAME}.xcarchive" \
            -exportPath "build/export" \
            -exportOptionsPlist "ExportOptions.plist"
          ls -la build/export

      - name: Upload .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-ipa
          path: build/export/*.ipa

      # Upload to TestFlight (Python writes valid JSON for the API key)
      - name: Upload to TestFlight
        run: |
          set -euxo pipefail
          gem install fastlane --no-document
          IPA_PATH=$(ls "$GITHUB_WORKSPACE/build/export/"*.ipa | head -n 1)

          printf "%s" "${APP_STORE_CONNECT_KEY}" > private_key.p8
          python3 - <<'PY'
          import json, os
          with open('private_key.p8','r') as f: key=f.read()
          data={"key_id":os.environ["APP_STORE_CONNECT_KEY_IDENTIFIER"],
                "issuer_id":os.environ["APP_STORE_CONNECT_ISSUER_ID"],
                "key":key}
          open('api_key.json','w').write(json.dumps(data))
          PY

          fastlane pilot upload \
            --api_key_path api_key.json \
            --ipa "$IPA_PATH" \
            --skip_waiting_for_build_processing true
