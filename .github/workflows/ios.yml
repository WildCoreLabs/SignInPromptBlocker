name: iOS – Build SignInPromptBlocker (manual signing)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    env:
      APP_NAME: SignInPromptBlocker
      BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      # ASC for TestFlight upload
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      # Signing files
      P12_BASE64: ${{ secrets.P12_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select xCode
        uses: maxim-lobanov/setup-xcode@v1
        with:
         xcode-version: "16.2"

      - name: Sanity check repo
        shell: bash
        run: |
          set -euxo pipefail
          ls -la "$GITHUB_WORKSPACE/extension"
           ls -la "$GITHUB_WORKSPACE/extension/icons"
          test -f "$GITHUB_WORKSPACE/extension/manifest.json"

      - name: Convert WebExtension → Xcode project (one line; path last)
        shell: bash
        run: |
          set -euxo pipefail
          EXT="$GITHUB_WORKSPACE/extension"
          PROJ="$RUNNER_TEMP/safari_project"
          mkdir -p "$PROJ"
          
          /usr/bin/xcrun safari-web-extension-converter "$EXT" --bundle-identifier "$BUNDLE_ID" --project-location "$PROJ" --no-open --force --app-name "$APP_NAME"

      - name: Locate converted xcode project
        shell: bash
        run: |
          set -euxo pipefail
          echo "searching...."
          find "$GITHUB_WORKSPACE" -maxdepth 4 -type d -name "*.xcworkspace" || true
          find "$RUNNER_TEMP" -maxdepth 4 -type d -name "*.xcworkspace" || true

     # - name: Build (archive) with xcodebuild
     #   shell: bash
     #   run: |
     #     set -euxo pipefail
     #     WORKSPACE="$RUNNER_TEMP/safari_project/$APP_NAME/$APP_NAME.xcodeproj/project.xcworkspace"
      #    SCHEME="$APP_NAME (iOS)"
     #     ARCHIVE_PATH="$GITHUB_WORKSPACE/build/${APP_NAME}.xcarchive"
      #    xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -configuration Release \
      #      -archivePath "$ARCHIVE_PATH" \
      #      clean archive
            
      - name: Decode signing assets
        run: |
          mkdir -p signing
          echo "$P12_BASE64" | base64 --decode > signing/dist.p12
          echo "$PROFILE_BASE64" | base64 --decode > signing/profile.mobileprovision

      - name: Create custom keychain & import cert
        run: |
          KEYCHAIN=build.keychain
          KEYCHAIN_PWD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security import signing/dist.p12 -k "$KEYCHAIN" -P "$P12_PASSWORD" -A
          security list-keychains -s "$KEYCHAIN" $(security list-keychains | sed 's/.*"\(.*\)".*/\1/')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN"

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i signing/profile.mobileprovision)")
          cp signing/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${UUID}.mobileprovision
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

      - name: Build (archive) with xcodebuild
        run: |
          PROJ_DIR="build/$APP_NAME"
          #WORKSPACE="$PROJ_DIR/$APP_NAME.xcworkspace"
          WORKSPACE="$RUNNER_TEMP/safari_project/$APP_NAME/$APP_NAME.xcodeproj/project.xcworkspace"
          SCHEME="$APP_NAME (iOS)"
          ARCHIVE_PATH="build/$APP_NAME.xcarchive"

          xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            clean archive | xcpretty || true

      - name: Create ExportOptions.plist
        run: |
          cat > build/ExportOptions.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.wildcorelabs.SignInPromptBlocker</key><string>${PROFILE_UUID}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Export .ipa
        run: |
          xcodebuild -exportArchive \
            -archivePath "build/$APP_NAME.xcarchive" \
            -exportPath "build/export" \
            -exportOptionsPlist "build/ExportOptions.plist" | xcpretty || true
          ls -la build/export

      - name: Upload .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: SignInPromptBlocker-ipa
          path: build/export/*.ipa

      - name: Install Fastlane & upload to TestFlight
        run: |
          gem install fastlane --no-document
          cat > fastlane.rb <<'RUBY'
          require 'fastlane'
          include Fastlane
          api_key = app_store_connect_api_key(
            key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
            issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
            key_content: ENV["APP_STORE_CONNECT_KEY"]
          )
          pilot(api_key: api_key, ipa: Dir['build/export/*.ipa'].first, skip_waiting_for_build_processing: true)
          RUBY
          ruby fastlane.rb
