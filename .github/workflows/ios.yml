name: iOS – Build SignInPromptBlocker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    env:
      APP_NAME: SignInPromptBlocker
      BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Xcode version
        run: xcodebuild -version
      - name: Install Fastlane
        run: gem install fastlane --no-document
      - name: Convert Web Extension → iOS app
        run: |
          mkdir -p build
          xcrun safari-web-extension-converter extension             --ios             --app-name "$APP_NAME"             --bundle-identifier "$BUNDLE_ID"             --project-location "build"             --no-open --force
      - name: Build & Upload via fastlane
        run: fastlane ios ci_build
      - name: Upload .ipa artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SignInPromptBlocker-ipa
          path: build/export/*.ipa
