name: iOS â€” Build & Upload (Signed)

on:
  workflow_dispatch:

jobs:
  build_and_upload:
    runs-on: macos-14

    env:
      PROJECT_PATH: ios/SignInPromptBlocker/SignInPromptBlocker.xcodeproj
      SCHEME: SignInPromptBlocker
      APP_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker
      EXT_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker.Extension
      TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Create temporary keychain & import .p12
        run: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          echo "${{ secrets.P12_BASE64 }}" | base64 --decode > cert.p12
          security import cert.p12 -k build.keychain -P "${{ secrets.P12_PASSWORD }}" -A
          security find-identity -v -p codesigning build.keychain

      - name: Install provisioning profiles (app + extension)
        id: profiles
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.PROVISION_PROFILE_ALL_BASE64 }}" | base64 --decode > app.mobileprovision
          echo "${{ secrets.PROVISION_PROFILE_EXT_BASE64 }}" | base64 --decode > ext.mobileprovision

          getInfo () { /usr/bin/security cms -D -i "$1" > tmp.plist; \
            uuid=$(/usr/libexec/PlistBuddy -c 'Print :UUID' tmp.plist); \
            name=$(/usr/libexec/PlistBuddy -c 'Print :Name' tmp.plist); \
            mv "$1" "$HOME/Library/MobileDevice/Provisioning Profiles/$uuid.mobileprovision"; \
            echo "$uuid|$name"; rm -f tmp.plist; }

          APP_INFO=$(getInfo app.mobileprovision)
          EXT_INFO=$(getInfo ext.mobileprovision)
          echo "APP_UUID=${APP_INFO%%|*}" >> $GITHUB_OUTPUT
          echo "APP_NAME=${APP_INFO##*|}"  >> $GITHUB_OUTPUT
          echo "EXT_UUID=${EXT_INFO%%|*}" >> $GITHUB_OUTPUT
          echo "EXT_NAME=${EXT_INFO##*|}" >> $GITHUB_OUTPUT

      - name: Build archive (Release, signed)
        run: |
          set -e
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ steps.profiles.outputs.APP_NAME }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain" \
            clean archive | xcpretty

      - name: Create export options
        run: |
          /usr/libexec/PlistBuddy -c "Add :method string app-store" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :teamID string $TEAM_ID" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:$APP_BUNDLE_ID string ${{ steps.profiles.outputs.APP_NAME }}" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:$EXT_BUNDLE_ID string ${{ steps.profiles.outputs.EXT_NAME }}" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :signingStyle string manual" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :destination string export" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :generateAppStoreInformation bool YES" ExportOptions.plist

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist | xcpretty
          ls -la build/export

      - name: Prepare ASC API key (safe JSON)
        run: |
          printf '%s' "${{ secrets.APP_STORE_CONNECT_KEY }}" > AuthKey.p8
          python3 - <<'PY'
          import os, json
          with open('AuthKey.p8','r') as f:
              key = f.read()
          data = {
            "key_id": os.environ["APP_STORE_CONNECT_KEY_IDENTIFIER"],
            "issuer_id": os.environ["APP_STORE_CONNECT_ISSUER_ID"],
            "key": key,
            "in_house": False
          }
          open('api_key.json','w').write(json.dumps(data))
          print("Wrote api_key.json")
          PY
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}

      - name: Upload to TestFlight
        run: |
          IPA_PATH=$(ls build/export/*.ipa | head -n 1)
          sudo gem install fastlane -NV
          fastlane pilot upload --api_key_path api_key.json --ipa "$IPA_PATH" --skip_waiting_for_build_processing true
