name: Bootstrap Safari Web Extension App (one-time)

on:
  workflow_dispatch:

env:
  XCODE_VERSION: "15.0"

jobs:
  bootstrap:
    runs-on: macos-latest
    permissions:
      contents: write   # allow committing generated project
    steps:
      - uses: actions/checkout@v4

      - name: Xcode version / converter check
        run: |
          xcodebuild -version
          xcrun --find safari-web-extension-converter

      - name: Generate Xcode project from /extension (fresh scaffold)
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app
          rm -rf ios
          mkdir -p ios
          xcrun safari-web-extension-converter extension \
            --project-location ios \
            --app-name "SignInPromptBlocker" \
            --no-prompt \
            --ios-only \
            --force
          echo "Generated structure:"
          find ios -maxdepth 3 -type d -print

      - name: Set bundle IDs (app + extension)
        run: |
          set -euo pipefail
      
          # Adjust these two if your scaffold ever changes:
          APP_PLIST="ios/SignInPromptBlocker/SignInPromptBlocker/Info.plist"
          EXT_PLIST="ios/SignInPromptBlocker/SignInPromptBlocker Extension/Info.plist"
      
          echo "App  Info.plist: $APP_PLIST"
          echo "Ext  Info.plist: $EXT_PLIST"
      
          # Show they exist (helps if paths ever change)
          ls -l "$APP_PLIST" "$EXT_PLIST"
      
          # Set (or add if missing) CFBundleIdentifier for the app target
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.wildcorelabs.SignInPromptBlocker" "$APP_PLIST" \
            || /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string com.wildcorelabs.SignInPromptBlocker" "$APP_PLIST"
      
          # Set (or add) CFBundleIdentifier for the extension target
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.wildcorelabs.SignInPromptBlocker.Extension" "$EXT_PLIST" \
            || /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string com.wildcorelabs.SignInPromptBlocker.Extension" "$EXT_PLIST"
      
          # Link extension â†’ host app (Safari expects this key)
          /usr/libexec/PlistBuddy -c "Set :WKAppBundleIdentifier com.wildcorelabs.SignInPromptBlocker" "$EXT_PLIST" \
            || /usr/libexec/PlistBuddy -c "Add :WKAppBundleIdentifier string com.wildcorelabs.SignInPromptBlocker" "$EXT_PLIST"

      - name: Verify plists (app + extension)
        run: |
          APP_PLIST="ios/SignInPromptBlocker/SignInPromptBlocker/Info.plist"
          EXT_PLIST="ios/SignInPromptBlocker/SignInPromptBlocker Extension/Info.plist"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PLIST"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$EXT_PLIST"
          /usr/libexec/PlistBuddy -c "Print :WKAppBundleIdentifier" "$EXT_PLIST"
          /usr/libexec/PlistBuddy -c "Print :NSExtension:NSExtensionPointIdentifier" "$EXT_PLIST" 
      
      
      - name: Commit generated Xcode project to repo
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add ios
          git commit -m "chore(bootstrap): add iOS Safari Web Extension App project (app + extension)"
          git push
