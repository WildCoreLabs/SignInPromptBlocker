name: iOS — Build & Upload (Safari Web Extension)

on:
  workflow_dispatch: {}

jobs:
  build_and_upload:
    runs-on: macos-14

    env:
      # === Edit only if your bundle IDs change ===
      APP_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker
      EXT_BUNDLE_ID: com.wildcorelabs.SignInPromptBlocker.Extension

      # Xcode project/scheme created by bootstrap
      PROJECT_PATH: ios/SignInPromptBlocker/SignInPromptBlocker.xcodeproj
      SCHEME: SignInPromptBlocker

      # Where we'll put the archive
      ARCHIVE_PATH: ${{ github.workspace }}/build/App.xcarchive

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: |
          set -e
          xcodebuild -version
          xcrun --find altool || true
          swift --version || true

      # ---------- Keychain + Distribution Cert ----------
      - name: Create temporary keychain & import .p12
        shell: bash
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          set -euo pipefail
          security create-keychain -p temp_pw build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p temp_pw build.keychain

          echo "$P12_BASE64" | base64 --decode > dist.p12
          security import dist.p12 -k build.keychain -P "$P12_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s build.keychain login.keychain
          security default-keychain -s build.keychain
          security find-identity -p codesigning -v

      # ---------- Provisioning Profiles (App + Extension) ----------
      - name: Install provisioning profiles (app + extension)
        shell: bash
        env:
          PROVISION_APP_B64: ${{ secrets.PROVISION_PROFILE_ALL_BASE64 }}
          PROVISION_EXT_B64: ${{ secrets.PROVISION_PROFILE_EXT_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          decode_and_place () {
            local b64="$1"
            local out="tmp.mobileprovision"
            echo "$b64" | base64 --decode > "$out"

            # extract UUID + Name
            UUID=$( /usr/bin/security cms -D -i "$out" | /usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin )
            NAME=$( /usr/bin/security cms -D -i "$out" | /usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin )

            mv "$out" "$HOME/Library/MobileDevice/Provisioning Profiles/${UUID}.mobileprovision"
            echo "Installed profile: $NAME (${UUID})"
          }

          decode_and_place "$PROVISION_APP_B64"
          decode_and_place "$PROVISION_EXT_B64"

      # ---------- Build .xcarchive ----------
      - name: Build archive (Release, signed)
        shell: bash
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          rm -rf "$(dirname "$ARCHIVE_PATH")"
          mkdir -p "$(dirname "$ARCHIVE_PATH")"

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain" \
            clean archive | xcpretty

          test -d "$ARCHIVE_PATH" && echo "✅ Archive created at: $ARCHIVE_PATH"

      # ---------- ExportOptions.plist ----------
      - name: Create export options
        shell: bash
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>signingStyle</key><string>manual</string>
            <key>destination</key><string>export</string>
            <key>generateAppStoreInformation</key><true/>
            <key>stripSwiftSymbols</key><true/>
            <key>uploadSymbols</key><true/>
            <key>provisioningProfiles</key>
            <dict>
              <key>${APP_BUNDLE_ID}</key><string>SignInPromptBlocker</string>
              <key>${EXT_BUNDLE_ID}</key><string>SignInPromptBlocker Extension</string>
            </dict>
          </dict>
          </plist>
          PLIST

          # Show it
          /usr/libexec/PlistBuddy -c "Print" ExportOptions.plist

      # ---------- Export .ipa ----------
      - name: Export IPA
        shell: bash
        run: |
          set -euo pipefail
          ls -la "$ARCHIVE_PATH"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist | xcpretty
          ls -la build/export

      # ---------- App Store Connect API key (safe JSON) ----------
      - name: Prepare ASC API key (safe JSON)
        shell: bash
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}  # base64 of the .p8 file
        run: |
          set -euo pipefail
          echo "$APP_STORE_CONNECT_KEY" | base64 --decode > AuthKey.p8
          python3 - <<'PY'
import json, os
with open('AuthKey.p8','r') as f:
    key = f.read()
data = {
  "key_id": os.environ["APP_STORE_CONNECT_KEY_IDENTIFIER"],
  "issuer_id": os.environ["APP_STORE_CONNECT_ISSUER_ID"],
  "key": key,
  "in_house": False
}
open('api_key.json','w').write(json.dumps(data))
print("Wrote api_key.json")
PY
          ls -l api_key.json

      # ---------- Upload to TestFlight ----------
      - name: Install fastlane
        run: sudo gem install fastlane -NV

      - name: Upload to TestFlight
        shell: bash
        env:
          IPA_PATH: build/export/*.ipa
        run: |
          set -euo pipefail
          IPA="$(ls -1 $IPA_PATH | head -n 1)"
          fastlane pilot upload \
            --api_key_path api_key.json \
            --ipa "$IPA" \
            --skip_waiting_for_build_processing true